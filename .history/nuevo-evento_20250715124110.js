// Initialize Firestore
const db = firebase.firestore();

// DOM Elements
const form = document.getElementById('eventForm');
const operadorSelect = document.getElementById('operador');
const numeroEventoInput = document.getElementById('numeroEvento');
const autoNumberIndicator = document.getElementById('autoNumberIndicator');

// Variable to track if number was auto-generated
let isAutoGenerated = false;

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    loadUsuarios();
    generateEventNumber(); // Auto-generate on page load
});

function initializeForm() {
    // Form submission
    form.addEventListener('submit', handleFormSubmit);
    
    // Track manual changes to event number
    numeroEventoInput.addEventListener('input', function() {
        if (this.value.trim() !== '') {
            isAutoGenerated = false;
            autoNumberIndicator.classList.add('hidden');
        }
    });
    
    // Clear auto-generated indicator on focus if user starts typing
    numeroEventoInput.addEventListener('focus', function() {
        if (isAutoGenerated) {
            autoNumberIndicator.classList.add('hidden');
        }
    });
}

// Generate automatic event number
async function generateEventNumber() {
    try {
        // Show loading state
        numeroEventoInput.value = '';
        numeroEventoInput.placeholder = 'Generando número...';
        numeroEventoInput.disabled = true;
        
        // Get the count of existing events to generate next consecutive number
        const eventosSnapshot = await db.collection('eventos').get();
        const nextNumber = eventosSnapshot.size + 1;
        
        // Format number with leading zeros (001, 002, etc.)
        const formattedNumber = nextNumber.toString().padStart(3, '0');
        
        // Set the generated number
        numeroEventoInput.value = formattedNumber;
        numeroEventoInput.placeholder = 'Ej: 001';
        numeroEventoInput.disabled = false;
        
        // Show indicator that it was auto-generated
        isAutoGenerated = true;
        autoNumberIndicator.classList.remove('hidden');
        
        console.log(`Número de evento generado automáticamente: ${formattedNumber}`);
        
    } catch (error) {
        console.error('Error al generar número de evento:', error);
        
        // Reset to manual state on error
        numeroEventoInput.placeholder = 'Ingrese número manualmente';
        numeroEventoInput.disabled = false;
        isAutoGenerated = false;
        autoNumberIndicator.classList.add('hidden');
        
        showMessage('Error al generar número automático. Ingrese el número manualmente.', 'error');
    }
}

// Check if event number already exists
async function checkEventNumberExists(numeroEvento) {
    try {
        const querySnapshot = await db.collection('eventos')
            .where('numeroEvento', '==', numeroEvento)
            .get();
        
        return !querySnapshot.empty;
    } catch (error) {
        console.error('Error al verificar número de evento:', error);
        return false;
    }
}

async function loadUsuarios() {
    try {
        // Show loading state in select
        operadorSelect.innerHTML = '<option value="">Cargando usuarios...</option>';
        
        const usuariosSnapshot = await db.collection('usuarios').orderBy('Nombre').get();
        
        // Clear loading option
        operadorSelect.innerHTML = '<option value="">Seleccione un operador</option>';
        
        usuariosSnapshot.forEach((doc) => {
            const usuario = doc.data();
            const option = document.createElement('option');
            option.value = usuario.Nombre || doc.id;
            option.textContent = usuario.Nombre || 'Usuario sin nombre';
            
            operadorSelect.appendChild(option);
        });
        
        // If no users found
        if (usuariosSnapshot.empty) {
            operadorSelect.innerHTML = '<option value="">No hay usuarios registrados</option>';
        }
        
    } catch (error) {
        console.error('Error al cargar usuarios:', error);
        operadorSelect.innerHTML = '<option value="">Error al cargar usuarios</option>';
        showMessage('Error al cargar la lista de usuarios: ' + error.message, 'error');
    }
}

// Función para mostrar la pantalla de éxito
function showSuccessScreen() {
    // Crear el overlay de la pantalla de éxito que cubre TODA la pantalla
    const successOverlay = document.createElement('div');
    successOverlay.id = 'successOverlay';
    successOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: #16a34a;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.3s ease-in-out;
    `;
    
    // Contenido de la pantalla de éxito
    successOverlay.innerHTML = `
        <div style="text-align: center; color: white; padding: 2rem;">
            <div style="margin-bottom: 2rem;">
                <svg style="width: 120px; height: 120px; margin: 0 auto; animation: pulse 2s infinite;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h2 style="font-size: 3rem; font-weight: bold; margin-bottom: 1.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">¡Evento Registrado!</h2>
            <p style="font-size: 1.5rem; margin-bottom: 2rem; opacity: 0.9;">El evento se ha guardado exitosamente</p>
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 1.25rem;">
                <span>Regresando al menú en</span>
                <span id="countdown" style="font-weight: bold; font-size: 2rem; color: #fef08a;">2</span>
                <span>segundos...</span>
            </div>
        </div>
    `;
    
    // Agregar el overlay al body
    document.body.appendChild(successOverlay);
    
    // Limpiar el formulario inmediatamente
    form.reset();
    
    // Limpiar cualquier estado de error
    const errorFields = document.querySelectorAll('.error');
    errorFields.forEach(field => field.classList.remove('error'));
    
    // Remover cualquier mensaje existente
    const messages = document.querySelectorAll('.success-message, .error-message');
    messages.forEach(msg => msg.remove());
    
    // Iniciar la cuenta regresiva
    let countdown = 2;
    const countdownElement = document.getElementById('countdown');
    
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdownElement) {
            countdownElement.textContent = countdown;
        }
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            // Redireccionar al menú
            window.location.href = 'menu.html';
        }
    }, 1000);
    
    // Agregar estilos CSS para las animaciones si no existen
    if (!document.getElementById('successStyles')) {
        const style = document.createElement('style');
        style.id = 'successStyles';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.9); }
                to { opacity: 1; transform: scale(1); }
            }
            @keyframes pulse {
                0%, 100% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.1); opacity: 0.8; }
            }
        `;
        document.head.appendChild(style);
    }
}

async function handleFormSubmit(e) {
    e.preventDefault();
    
    // Show loading state
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Guardando...';
    submitButton.disabled = true;
    form.classList.add('loading');

    try {
        // Collect form data
        const formData = new FormData(form);
        const eventData = {
            // Información General (solo guardar campos que no estén vacíos)
            numeroEvento: formData.get('numeroEvento'),
            nombreEvento: formData.get('nombreEvento'),
            fechaInicio: formData.get('fechaInicio') || null,
            fechaFinal: formData.get('fechaFinal') || null,
            zona: formData.get('zona') || null,
            ciudad: formData.get('ciudad') || null,
            operador: formData.get('operador') || null,
            
            // Metadata
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
            fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Validate required fields (solo nombre y número)
        if (!validateForm(eventData)) {
            throw new Error('Por favor complete todos los campos requeridos');
        }
        
        // Check if event number already exists
        const numberExists = await checkEventNumberExists(eventData.numeroEvento);
        if (numberExists) {
            highlightError('numeroEvento');
            throw new Error(`El número de evento "${eventData.numeroEvento}" ya existe. Use un número diferente.`);
        }

        // Save to Firestore
        const docRef = await db.collection('eventos').add(eventData);
        
        console.log('Evento guardado con ID:', docRef.id);
        
        // Mostrar pantalla de éxito y redireccionar
        showSuccessScreen();
        
    } catch (error) {
        console.error('Error al guardar evento:', error);
        showMessage('Error al guardar el evento: ' + error.message, 'error');
        
        // Reset button state on error
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
        form.classList.remove('loading');
    }
}

function validateForm(data) {
    // Solo validar campos obligatorios: nombre y número de evento
    const requiredFields = ['numeroEvento', 'nombreEvento'];
    
    for (let field of requiredFields) {
        if (!data[field] || data[field].toString().trim() === '') {
            highlightError(field);
            return false;
        }
    }
    
    return true;
}

function highlightError(fieldName) {
    const field = document.getElementById(fieldName);
    if (field) {
        field.classList.add('error');
        field.focus();
        
        // Remove error class after a few seconds
        setTimeout(() => {
            field.classList.remove('error');
        }, 3000);
    }
}

function showMessage(message, type) {
    // Remove existing messages
    const existingMessages = document.querySelectorAll('.success-message, .error-message');
    existingMessages.forEach(msg => msg.remove());
    
    // Create new message
    const messageDiv = document.createElement('div');
    messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
    messageDiv.textContent = message;
    
    // Insert message at the top of the form
    const formContainer = document.querySelector('.bg-white.rounded-xl');
    formContainer.insertBefore(messageDiv, form);
    
    // Auto-remove message after 5 seconds
    setTimeout(() => {
        messageDiv.remove();
    }, 5000);
}

function resetForm() {
    if (confirm('¿Está seguro de que desea limpiar todos los campos?')) {
        form.reset();
        
        // Clear any error states
        const errorFields = document.querySelectorAll('.error');
        errorFields.forEach(field => field.classList.remove('error'));
        
        // Remove any messages
        const messages = document.querySelectorAll('.success-message, .error-message');
        messages.forEach(msg => msg.remove());
        
        // Regenerate event number automatically
        generateEventNumber();
    }
}

// Function to load event data (for editing)
async function loadEventData(eventId) {
    try {
        const doc = await db.collection('eventos').doc(eventId).get();
        
        if (doc.exists) {
            const data = doc.data();
            
            // Populate form fields
            Object.keys(data).forEach(key => {
                const field = document.getElementById(key);
                if (field) {
                    if (field.type === 'checkbox') {
                        field.checked = data[key];
                    } else if (field.type === 'date' && data[key]) {
                        // Convert Firestore timestamp to date string
                        const date = data[key].toDate ? data[key].toDate() : new Date(data[key]);
                        field.value = date.toISOString().split('T')[0];
                    } else {
                        field.value = data[key] || '';
                    }
                }
            });
            
            // Handle special cases - no additional logic needed for simplified form
            
        } else {
            showMessage('Evento no encontrado', 'error');
        }
    } catch (error) {
        console.error('Error al cargar evento:', error);
        showMessage('Error al cargar los datos del evento', 'error');
    }
}

// Function to refresh usuarios list
function refreshUsuarios() {
    loadUsuarios();
}

// Export functions for external use
window.loadEventData = loadEventData;
window.resetForm = resetForm;
window.refreshUsuarios = refreshUsuarios;
window.generateEventNumber = generateEventNumber;